# 部署前提条件
1. ap='ansible-playbook -u ctang -b -v'
2. 被控主机已经配置了SSH秘钥认证
3. 被控主机已经有了相应的用户ctang, 并且设置了sudo不需要输入密码
4. 被控主机关闭了SELinux和iptables

# MongoDB安装
可以选择yum在线安装方式，也可以选择本地rpm安装包安装

# 为了缩小提交的代码大小，删除掉 roles/mongodb-3/files/mongodb-install/ 下的以下文件，安装时可以使用 yum install --downloadonly --downloaddir=/download mongodb-org 下载下来
mongodb-org-server-3.4.6-1.el6.x86_64.rpm
mongodb-org-shell-3.4.6-1.el6.x86_64.rpm
mongodb-org-tools-3.4.6-1.el6.x86_64.rpm
mongodb-org-mongos-3.4.6-1.el6.x86_64.rpm

# 部署环境
1. 3台机器
2. 端口设定：
mongos为20000，config server为21000，shard1为22001 ，shard2为22002，shard3为22003.

# 部署Sharding环境
ap -i hosts deploy-sharding.yml

# 测试Sharding
ap -i hosts playbooks/test-sharding.yml -e servername=local-centos68-test01

# 主机名变更时需要修改的地方
1. hosts 
2. roles/mongoc/tasks/mongoc_init.yml
3. roles/mongod/tasks/mongod_set_repl.yml
4. roles/shard-init/tasks/main.yml 

# 需要扩展时
0. mongoc 和 mongos会自动扩展
1. 添加 roles/mongod/templates/mongod-shard*.conf.j2 和 roles/mongod/templates/shard*_repl_set_conf.js.j2
2. 修改 roles/shard-init/templates/shard_init.j2
3. 添加相应配置到 roles/mongod/tasks/mongod_init.yml 和 roles/mongod/tasks/mongod_set_repl.yml

# 参考文档
1. https://oracleblog.org/working-case/mongdb-study-note/
2. https://docs.mongodb.com/manual/tutorial/deploy-shard-cluster/
3. https://github.com/ansible/ansible-examples/tree/master/mongodb
